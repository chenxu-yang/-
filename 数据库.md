# 数据库

## 一、事务

### 1. ACID

1. 原子性：事务的所有操作要么全部提交成功，要么全部失败回滚
2. 一致性：数据库在事务执行前后都保持一致性状态。所有事务对同一个数据的读取结果都是相同的
3. 隔离性：一个事务所做的修改在最终提交之前，其他事务不可见
4. 持久性：一旦事务提交，修改会永久保存到数据库中，即使系统崩溃，结果也不丢失

![img](https://camo.githubusercontent.com/05ba47a03214cd6a2d9a4c43989b0893bb99c5e0/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f696d6167652d32303139313230373231303433373032332e706e67)

***

### 2. 并发一致性问题

* 丢失修改： 丢失修改指一个事务的更新操作被另外一个事务的更新操作替换。T1 和 T2 两个事务都对一个数据进行修改，T1 先修改并提交生效，T2 随后修改，T2 的修改覆盖了 T1 的修改。
* 脏读：读脏数据指在不同的事务下，当前事务可以读到另外事务未提交的数据。例如：T1 修改一个数据但未提交，T2 随后读取这个数据。如果 T1 撤销了这次修改，那么 T2 读取的数据是脏数据。
* 不可重复读：不可重复读指在一个事务内多次读取同一数据集合。在这一事务还未结束前，另一事务也访问了该同一数据集合并做了修改，由于第二个事务的修改，第一次事务的两次读取的数据可能不一致。例如：T2 读取一个数据，T1 对该数据做了修改。如果 T2 再次读取这个数据，此时读取的结果和第一次读取的结果不同。
* 幻读本质上也属于不可重复读的情况，T1 读取某个范围的数据，T2 在这个范围内插入新的数据，T1 再次读取这个范围的数据，此时读取的结果和和第一次读取的结果不同。

***

### 3. 封锁

* 封锁粒度

  mysql中提供两种封锁粒度：行级锁和表级锁

  粒度越小，系统开销就越大

* 封锁类型

  * 读写锁：

    * 互斥锁
    * 共享锁

    有以下两个规定：

    - 一个事务对数据对象 A 加了 X 锁，就可以对 A 进行读取和更新。加锁期间其它事务不能对 A 加任何锁。
    - 一个事务对数据对象 A 加了 S 锁，可以对 A 进行读取操作，但是不能进行更新操作。加锁期间其它事务能对 A 加 S 锁，但是不能加 X 锁。

  * 意向锁

    使用意向锁（Intention Locks）可以更容易地支持多粒度封锁。

    在存在行级锁和表级锁的情况下，事务 T 想要对表 A 加 X 锁，就需要先检测是否有其它事务对表 A 或者表 A 中的任意一行加了锁，那么就需要对表 A 的每一行都检测一次，这是非常耗时的。

    意向锁在原来的 X/S 锁之上引入了 IX/IS，IX/IS 都是表锁，用来表示一个事务想要在表中的某个数据行上加 X 锁或 S 锁。有以下两个规定：

    - 一个事务在获得某个数据行对象的 S 锁之前，必须先获得表的 IS 锁或者更强的锁；
    - 一个事务在获得某个数据行对象的 X 锁之前，必须先获得表的 IX 锁。

    通过引入意向锁，事务 T 想要对表 A 加 X 锁，只需要先检测是否有其它事务对表 A 加了 X/IX/S/IS 锁，如果加了就表示有其它事务正在使用这个表或者表中某一行的锁，因此事务 T 加 X 锁失败。

* MySQL隐式与显示锁定

  MySQL 的 InnoDB 存储引擎采用两段锁协议，会根据隔离级别在需要的时候自动加锁，并且所有的锁都是在同一时刻被释放，这被称为隐式锁定。

  InnoDB 也可以使用特定的语句进行显示锁定：

  ```sql
  SELECT ... LOCK In SHARE MODE;
  SELECT ... FOR UPDATE;
  ```



***

### 4. 隔离级别

* 未提交读：事务中的修改，即使没有提交，对其它事务也是可见的。

* 提交读：一个事务只能读取已经提交的事务所做的修改。换句话说，一个事务所做的修改在提交之前对其它事务是不可见的。

* 可重复读：保证在同一个事务中多次读取同一数据的结果是一样的。

* 可串行化：强制事务串行执行，这样多个事务互不干扰，不会出现并发一致性问题。

  该隔离级别需要加锁实现，因为要使用加锁机制保证同一时间只有一个事务执行，也就是保证事务串行执行。

***

### 5.数据库设计

* 三大范式：
  * 属性不可分
  * 每个非主属性完全函数依赖于主键
  * 非主键不传递函数依赖于主键
* ER图